<link rel="import" href="../polymer/polymer.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <comparison-element></comparison-element>

@element comparison-element
@blurb Element providing graphical metric comparison.
@status beta
@homepage https://github.com/the-control-group/comparison-element
-->
<polymer-element name="comparison-element" attributes="chart-area-width
                                                       chart-area-height
                                                       chart-line-colors
                                                       chart-h-axis-text-style-color
                                                       chart-v-axis-baseline-color
                                                       chart-v-axis-text-style-color
                                                       enable-transpose-action">
  <template>
    <link rel="stylesheet" href="comparison-element.css">

    <div id="header">
      <div id="chart" class="chart">
        <core-icon id="icon" icon="more-vert" on-click="{{onTransposeIconClick}}"></core-icon>
        <div id="line_chart"></div>
      </div>
    </div>
    <div id="body">
      <content id="main-metric-data" select="comparison-element-main-metric"></content>
      <div id="main-metric">
        <template id="main-metric-template" bind="{{metric}}">
          <div>
            <div class="label">
              {{label}}
            </div>
            <div class="stat">
              {{stat}}
            </div>
          </div>
        </template>
      </div>
      <content id="metrics-data" select="comparison-element-metric"></content>
      <div id="metrics">
        <template id="metrics-template" repeat="{{metrics}}">
          <div id="metric-1" class="metric">
            <div>
              <div class="label">
                {{label}}
              </div>
              <div class="stat">
                {{stat}}
              </div>
              <div class="change">
                {{change}}
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      /**
       * Publish lifecycle object (instantiate, type hint)
       * @property {boolean|object} chart
       * @property {string} chart-area-width
       * @property {string} chart-area-height
       * @property {array} chart-line-colors
       * @property {string} chart-h-axis-text-style-color
       * @property {string} chart-v-axis-baseline-color
       * @property {string} chart-v-axis-text-style-color
       */
      publish: {
        chart: false,
        'chart-area-width': '90%',
        'chart-area-height': '80%',
        'chart-line-colors': ['#fff'],
        'chart-h-axis-text-style-color': '#fff',
        'chart-v-axis-baseline-color': '#fff',
        'chart-v-axis-text-style-color': '#fff'
      },

      /**
       * Attribute changed lifecycle method
       * @param {string} attrName
       * @param {string} oldVal
       * @param {string} newVal
       */
      attributeChanged: function(attrName, oldVal, newVal) {
        // Listen for when the element height changes to calculate the height of the direct children of the header
        // and body
        this.calculateWidthsAndHeights.call(this);
      },

      /**
       * Ready lifecycle method
       */
      ready: function () {
        // Render Main Metric
        this.async(this.renderMainMetric);

        // Render Additional Metrics
        this.async(this.renderAdditionalMetrics);

        // Initially calculate header and body heights
        this.async(this.calculateWidthsAndHeights);

        // Initially draw the line chart
        this.async(this.drawChart);

        // Setup transpose icon if transpose action enabled
        if (this['enable-transpose-action']) {
          this.$.icon.style.cursor = 'pointer';
          this.$.icon.style.display = 'block';
        }
      },

      /**
       * Calculate widths and heights method for layout re-rendering
       */
      calculateWidthsAndHeights: function() {
       var header = this.$.header,
           lineChart = this.$.line_chart,
           body = this.$.body,
           lineChartWidth,
           lineChartHeight,
           headerHeight,
           bodyHeight;

          // Calculate header height (48%)
          headerHeight = Math.round(.48 * this.clientHeight);
          header.style.height = headerHeight + 'px';

          // Calculate line chart width and height
          lineChartWidth = header.clientWidth;
          lineChartHeight = headerHeight;
          lineChart.style.width = lineChartWidth + 'px';
          lineChart.style.height = lineChartHeight + 'px';

          // Calculate body height (52%)
          bodyHeight = Math.round(.52 * this.clientHeight);
          body.style.height = bodyHeight + 'px';
      },

      /**
       * Render Main Metric
       */
      renderMainMetric: function() {
        var data = this.$['main-metric-data'].getDistributedNodes().item(0);

        this.$['main-metric-template'].model = {
          metric: {
            label: data.label,
            stat: data.stat
          }
        };
      },

      /**
       * Render Additional Metrics
       */
      renderAdditionalMetrics: function() {
        var data = this.$['metrics-data'].getDistributedNodes().array(),
            i;

        this.$['metrics-template'].model = { metrics: [] };
        for (i = 0; i < data.length; i++) {
          this.$['metrics-template'].model.metrics[i] = {
            label: data[i].label,
            stat: data[i].stat
          };
        }
      },

      /**
       * Draw the chart
       */
      drawChart: function() {
        var data,
            baseline,
            options;

        data = google.visualization.arrayToDataTable([
          ['Day', 'Stats'],
          ['01', 0],
          ['02', 2],
          ['03', 3],
          ['04', 4],
          ['05', 0],
          ['06', 0],
          ['07', 0]
        ]);

        baseline = Math.round(2.1);

        options = {
          backgroundColor: 'transparent',
          chartArea: {
            left: 13,
            top: 10,
            width: this['chart-area-width'],
            height:this['chart-area-height']
          },
          colors: this['chart-line-colors'],
          curveType: 'function',
          hAxis: {
            textStyle: {
              color: this['chart-h-axis-text-style-color'],
              opacity: 0.5
            }
          },
          legend: {
            position: 'none'
          },
          lineWidth: 2,
          vAxis: {
            baseline: baseline,
            baselineColor: this['chart-v-axis-baseline-color'],
            format: 'short',
            gridlines: {
              color: 'transparent',
              count: 5
            },
            textStyle: {
              color: this['chart-v-axis-text-style-color'],
              opacity: 0.5
            }
          }
        };

        // Determine if the chart has been initialized
        if (!this.chart) {
          this.chart = new google.visualization.LineChart(this.$.line_chart);
        }

        this.chart.draw(data, options);
      },

      // Events

      /**
       * On transpose icon click event
       * @param {object} event
       * @param {number} detail
       * @param {object} sender
       */
      onTransposeIconClick: function(event, detail, sender) {
        this.fire('transpose');
      }
    });
  </script>
</polymer-element>

<polymer-element name="comparison-element-main-metric" attributes="label stat format">
  <script>
    Polymer('comparison-element-main-metric', {
      publish: {
        stat: {
          reflect: true
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="comparison-element-metric" attributes="label stat format">
  <script>
    Polymer('comparison-element-metric', {
      publish: {
        stat: {
          reflect: true
        }
      }
    });
  </script>
</polymer-element>
