<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="comparison-element-metric.html">
<link rel="import" href="comparison-element-main-metric.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <comparison-element></comparison-element>

@element comparison-element
@blurb Element providing graphical metric comparison.
@status beta
@homepage https://github.com/the-control-group/comparison-element
@see https://developers.google.com/chart/interactive/docs/gallery/linechart
-->
<polymer-element name="comparison-element" attributes="chart-area-width
                                                       chart-area-height
                                                       chart-data-columns
                                                       chart-data-rows
                                                       chart-line-colors
                                                       chart-h-axis-text-style-color
                                                       chart-v-axis-text-style-color
                                                       enable-menu-action
                                                       enable-transpose-action">
  <template class="test">
    <link rel="stylesheet" href="comparison-element.css">
    <div id="front">
      <div id="header">
        <div id="chart" class="chart">
          <core-icon id="icon" icon="more-vert" on-click="{{onMenuIconClick}}"></core-icon>
          <div id="line_chart"></div>
          <img id="action" src="action.png" on-click="{{onTransposeImageClick}}">
        </div>
      </div>
      <div id="body">
        <div id="main-metric">
          <content id="main-metric-data" select="comparison-element-main-metric"></content>
        </div>
        <div id="metrics">
          <content id="metrics-data" select="comparison-element-metric"></content>
        </div>
      </div>
    </div>
    <div id="back">
      <content id="transposed-content" select="transposed-content"></content>
    </div>
  </template>
  <script>
    Polymer({
      /**
       * Publish lifecycle object (instantiate, type hint)
       * @property {boolean|object} chart
       * @property {string} chart-area-width
       * @property {string} chart-area-height
       * @property {array} chart-data-columns
       * @property {array} chart-data-rows
       * @property {number} chart-data-baseline
       * @property {array} chart-line-colors
       * @property {string} chart-h-axis-text-style-color
       * @property {string} chart-v-axis-text-style-color
       * @property {boolean} enable-transpose-action
       */
      publish: {
        chart: false,
        'chart-area-width': '82%',
        'chart-area-height': '70%',
        'chart-data-columns': {
          value: ['Day', 'Metric'],
          reflect: true
        },
        'chart-data-rows': {
          value: [],
          reflect: true
        },
        'chart-data-baseline': {
          value: 0,
          reflect: true
        },
        'chart-line-colors': ['#fff', '#ffd200'],
        'chart-h-axis-text-style-color': '#fff',
        'chart-v-axis-text-style-color': '#fff',
        'enable-menu-action': false,
        'enable-transpose-action': false
      },

      /**
       * Attribute changed lifecycle method
       * @param {string} attrName
       * @param {string} oldVal
       * @param {string} newVal
       */
      attributeChanged: function(attrName, oldVal, newVal) {
        // Listen for when the element height changes to calculate the height of the direct children of the header
        // and body
        this.calculateWidthsAndHeights.call(this);
      },

      /**
       * Ready lifecycle method
       */
      ready: function () {
        // Initially calculate header and body heights
        this.async(this.calculateWidthsAndHeights);

        // Initially draw the line chart
        this.async(this.drawChart);

        // Setup menu icon if menu action enabled
        if (this['enable-menu-action']) {
          this.$.icon.style.cursor = 'pointer';
          this.$.icon.style.display = 'block';
        }

        // Setup transpose image if transpose action enabled
        if (this['enable-transpose-action']) {
          this.$.action.style.cursor = 'pointer';
          this.$.action.style.display = 'block';
        }

        // Element mouseleave event
        this.addEventListener('mouseleave', this.onElementMouseleave);
      },

      /**
       * Calculate widths and heights method for layout re-rendering
       */
      calculateWidthsAndHeights: function() {
       var header = this.$.header,
           lineChart = this.$.line_chart,
           body = this.$.body,
           lineChartWidth,
           lineChartHeight,
           headerHeight,
           bodyHeight;

          // Calculate header height (48%)
          headerHeight = Math.round(.48 * this.clientHeight);
          header.style.height = headerHeight + 'px';

          // Calculate line chart width and height
          lineChartWidth = header.clientWidth;
          lineChartHeight = headerHeight;
          lineChart.style.width = lineChartWidth + 'px';
          lineChart.style.height = lineChartHeight + 'px';

          // Calculate body height (52%)
          bodyHeight = Math.round(.52 * this.clientHeight);
          body.style.height = bodyHeight + 'px';
      },

      /**
       * Draw the chart
       */
      drawChart: function() {
        var data = new google.visualization.DataTable(),
            options,
            i,
            type;

        // Add the columns
        for (i = 0; i < this['chart-data-columns'].length; i++) {
          if (i === 0) {
            type = 'number';
          } else {
            type = 'number';
          }
          data.addColumn(type, this['chart-data-columns'][i]);
        }

        // Add the rows
        data.addRows(this['chart-data-rows']);

        // Set the options
        options = {
          backgroundColor: {
            fill: 'transparent'
          },
          chartArea: {
            left: 13,
            top: 10,
            width: this['chart-area-width'],
            height:this['chart-area-height']
          },
          colors: this['chart-line-colors'],
          curveType: 'function',
          hAxis: {
            baselineColor: 'transparent',
            gridlines: {
              color: 'transparent',
              count: this['chart-data-rows'] ? this['chart-data-rows'].length : 0
            },
            textStyle: {
              color: this['chart-h-axis-text-style-color'],
              opacity: 0.5
            }
          },
          legend: {
            position: 'none'
          },
          lineWidth: 2,
          trendlines: {
            0: {
              lineWidth: 1
            }
          },
          vAxis: {
            baseline: this['chart-data-baseline'],
            baselineColor: 'transparent',
            format: 'short',
            gridlines: {
              color: 'transparent',
              count: 5
            },
            textStyle: {
              color: this['chart-v-axis-text-style-color'],
              opacity: 0.5
            }
          }
        };

        // Determine if the chart has been initialized
        if (!this.chart) {
          // Initiliaze the chart
          this.chart = new google.visualization.LineChart(this.$.line_chart);
        }

        // Draw the chart
        this.chart.draw(data, options);
      },

      // Events

      /**
       * On menu icon click event
       * @param {object} event
       * @param {number} detail
       * @param {object} sender
       */
      onMenuIconClick: function(event, detail, sender) {
        this.fire('menu-click');
      },

      /**
       * on element mouseleave
       * @param {object} event
       * @param {number} detail
       * @param {object} sender
       */
      onElementMouseleave: function(event, detail, sender) {
        var transposedClassRegExp = new RegExp('(\\s|^)transposed(\\s|$)');

        // Remove transposed class
        this.className = this.className.replace(transposedClassRegExp, ' ');
      },

      /**
       * On transpose image click event
       * @param {object} event
       * @param {number} detail
       * @param {object} sender
       */
      onTransposeImageClick: function(event, detail, sender) {
        // Add transposed class
        if (!this.className.match(new RegExp('(\\s|^)transposed(\\s|$)'))) {
          this.className += ' ' + 'transposed';
        }

        this.fire('transpose-action-click');
      }
    });
  </script>
</polymer-element>
